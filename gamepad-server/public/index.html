<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="description" content="Flying Drones!">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>HTML 5 gamepad API</title>
        <style>
          table {
            width:100%;
          }
          td {
            text-align: center;
          }
          .button {
            display:inline-block;
            color: rgb(37,37,37);
            text-shadow: 0px 1px 1px rgba(250,250,250,0.1);
            font-size: 32pt;
            position: relative;
            text-decoration: none;
            background-color: rgb(83,87,93);
            box-shadow: 0px 3px 0px 0px rgb(34,34,34), /* 1st Shadow */
                       0px 7px 10px 0px rgb(17,17,17), /* 1nd Shadow */
                       inset 0px 1px 1px 0px rgba(250, 250, 250, .2), /* 3rd Shadow */
                       inset 0px -12px 35px 0px rgba(0, 0, 0, .5); /* 4th Shadow */
            width: 70px;
            height: 70px;
            border: 0;
            border-radius: 20px;
            text-align: center;
            line-height: 70px;
            margin: 7px 24px;
          }
          .button.pressed {
            box-shadow: 0px 0px 0px 0px rgb(34,34,34),
               0px 3px 7px 0px rgb(17,17,17),
               inset 0px 1px 1px 0px rgba(250, 250, 250, .2),
               inset 0px -10px 35px 5px rgba(0, 0, 0, .5);
            background-color: rgb(83,87,93);
            top: 3px;
            color: #fff;
            text-shadow: 0px 0px 3px rgb(250,250,250);
          }
          .pad {
            position:relative;
            display: inline-block;
            margin:10px;
            width:100px;
            height:100px;
            background-color: rgb(83,87,93);
            box-shadow: 0px 3px 0px 0px rgb(34,34,34), /* 1st Shadow */
                       0px 7px 10px 0px rgb(17,17,17), /* 1nd Shadow */
                       inset 0px 1px 1px 0px rgba(250, 250, 250, .2), /* 3rd Shadow */
                       inset 0px -12px 35px 0px rgba(0, 0, 0, .5); /* 4th Shadow */
          }
          .pad-indicator {
            position: absolute;
            width:2px;
            height:2px;
            top:50%;
            left:50%;
            margin-left: -1px;
            margin-top:-1px;
            background-color:white;
          }
          .pad.active .pad-indicator {
            background-color:red;
            border:1px solid:white;
            width:4px;
            height:4px;
            margin-left: -2px;
            margin-top:-2px;
          }
        </style>
    </head>
    <body>
        <h1>Free Controller</h1>

        <table>
          <tr>
            <td colspan=3>
              <div class="button pressed" id="l1">L1</div>
            </td>
            <td colspan=3>
              <div class="button" id="r1">R1</div>
            </td>
          </tr>
          <tr>
            <td colspan=2>
              <div class="button" id="up">↑</div><br/>
              <div class="button" id="left">←</div>
              <div class="button" id="right">→</div><br/>
              <div class="button" id="down">↓</div>
            </td>
            <td colspan=2>
              <div class="pad" id="leftpad">
                <div class="pad-indicator"></div>
              </div>
              <div class="pad" id="rightpad">
                <div class="pad-indicator"></div>
              </div>
            </td>
            <td colspan=2>
              <div class="button" id="b1">1</div><br/>
              <div class="button" id="b4">4</div>
              <div class="button" id="b2">2</div><br/>
              <div class="button" id="b3">3</div>
            </td>
          </tr>
        </table>

        <script src="/lib/starfox.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.1.6/zepto.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.13.1/lodash.min.js"></script>
        <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
        <script>

          var padWidth = $('.pad').width(),
              padHeight = $('.pad').height();

          var setPad = function(id, coords) {
            var x = coords.x,
                y = coords.y,
                translateX = x * padWidth/2,
                translateY = y * padHeight/2;

            $('#'+id+" .pad-indicator").attr("style", "transform:translateX("+translateX+"px) translateY("+translateY+"px);")

            if(Math.round(x*100)!=0 || Math.round(y*100)!=0) {
              $('#'+id).addClass("active")
            } else {
              $('#'+id).removeClass("active")
            }
          }

          var toggleButton = function(id, pressed) {
            if (pressed) {
              $('#'+id).addClass("pressed");
            } else {
              $('#'+id).removeClass("pressed");
            }
          }

          var updateGamepadUi = function(gamepad) {
            toggleButton("l1", gamepad.l1);
            toggleButton("r1", gamepad.r1);
            toggleButton("up", gamepad.up);
            toggleButton("down", gamepad.down);
            toggleButton("right", gamepad.right);
            toggleButton("left", gamepad.left);
            toggleButton("b1", gamepad.b1);
            toggleButton("b2", gamepad.b2);
            toggleButton("b3", gamepad.b3);
            toggleButton("b4", gamepad.b4);
            setPad("leftpad", gamepad.leftpad)
            setPad("rightpad", gamepad.rightpad)
          }

          var parseGamepad = function(gamepad) {
            return {
              l1: gamepad.buttons[4].pressed,
              r1: gamepad.buttons[5].pressed,
              up: gamepad.buttons[12].pressed,
              down: gamepad.buttons[13].pressed,
              right: gamepad.buttons[15].pressed,
              left: gamepad.buttons[14].pressed,
              b1: gamepad.buttons[0].pressed,
              b2: gamepad.buttons[1].pressed,
              b3: gamepad.buttons[2].pressed,
              b4: gamepad.buttons[3].pressed,
              leftpad : { x : gamepad.axes[0], y : gamepad.axes[1] },
              rightpad : { x : gamepad.axes[2], y : gamepad.axes[3] }
            }
          }

          var socket = io();
          var sf = new Starfox();
          sf.on('input', function(gamepads) {
              // Only use the first one
              var gamepad = parseGamepad(gamepads[0]);
              updateGamepadUi(gamepad)
              socket.emit('input', gamepad);
          });

        </script>
    </body>
</html>
